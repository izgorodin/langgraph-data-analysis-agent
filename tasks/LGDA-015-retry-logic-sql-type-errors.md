# LGDA-015: Correct Retry Logic for SQL Validation and Type Mismatch Errors

**Priority**: HIGH | **Type**: Reliability | **Parallel**: Can run with LGDA-007, LGDA-009

## Архитектурный контекст
Единая ретрай-архитектура (LGDA-007) должна корректно переинициировать генерацию SQL при проблемах уровня валидации и несоответствия типов (например, TIMESTAMP vs DATE). Текущее поведение: retry_count остаётся 0, повтор не происходит.

## Цель задачи
Исправить условия ретрая на уровне графа/состояния так, чтобы ошибки валидации и несоответствия типов вызывали ограниченное число повторов с упрощением/коррекцией SQL.

## Детальный анализ
- Проблема: state.retry_count не инкрементится и ветка ретрая не активируется.
- Возможные причины: неправильное связывание state.error с решением «should_retry», неверное обнуление состояния, отсутствие backoff.

## Решение (Solution Architecture)
1. Правила ретрая
   - Ошибки категории USER_GUIDED for SQL validation/type mismatch → до N попыток (N=2) с упрощением запроса.
   - Инфраструктурные (429, timeouts) → backoff + провайдерный фолбэк (см. LGDA-016).
2. Изменения в графе
   - В `src/agent/graph.py`: корректная реализация `_should_retry_*` с учётом `state.error.category`, гарантированный `state.retry_count += 1`.
3. Логгирование
   - Явные логи решений о ретрае с причиной, категорией, попыткой.
4. Тесты
   - Юнит: эмуляция TIMESTAMP vs DATE; проверка 2 попыток и упрощения.
   - Интеграция: end-to-end через план→sql→validate→execute.

## Критерии приемки
- При несоответствии типов инициируются до 2 повторов генерации SQL с упрощением.
- retry_count инкрементируется и отражается в state и логах.
- При достижении лимита — корректное завершение с USER_GUIDED ошибкой, без отчёта (см. LGDA-014).

## Возможные сложности
- Грань между BUSINESS_LOGIC (ретраится) и PERMANENT (не ретраится).
- Риск циклической генерации «похожих» запросов без улучшения.
- Стабильность моков BQ и DataFrame в тестах.

## Integration Points
- LGDA-007 Unified Retry — единые стратегии и лимиты.
- LGDA-009 Error Handling — корректная классификация ValueError → BUSINESS_LOGIC.
- LGDA-014 No-Fabrication — отсутствие отчёта при превышении лимитов.

## ADR References
- ADR-003 Error Handling Strategy — определение категорий ошибок и их ретрай.

## Безопасность
- Строгая валидация и авто-LIMIT для неконсолидированных запросов.
- Белый список таблиц и защитные политики sqlglot не ослабляются при ретраях.

## Производительность
- Макс 2 повтора с backoff ≤ 2s; ограничение стоимости BQ запросов сохраняется.
- Логи решений о ретрае не должны существенно влиять на время выполнения.

## Зависимости
- LGDA-007, LGDA-009

## Оценка трудозатрат
1 день | Изменения: 2–3 файла | Тесты: 4–6
