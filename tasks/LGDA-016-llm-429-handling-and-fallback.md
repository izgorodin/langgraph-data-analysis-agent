# LGDA-016: Robust LLM 429 Handling, Backoff, and Provider Fallback

**Priority**: HIGH | **Type**: Reliability/Throughput | **Parallel**: Can run with LGDA-011, LGDA-007

## Архитектурный контекст
Провайдер Gemini вернул 429 несмотря на ожидаемую квоту. Нужна надёжная обработка rate limit: экспоненциальный backoff с джиттером, circuit breaker, fallback на NVIDIA OpenAI-совместимый провайдер.

## Цель задачи
Обеспечить устойчивость к 429/квотам: корректный backoff, временное отключение «горячего» провайдера, автоматический фолбэк на альтернативу, телеметрия по rate-limit событиям.

## Детальный анализ
- Текущее состояние: 429 приводит к немедленному провалу без ретраев и без переключения.
- Риск: деградация UX и «шторма» запросов при временных лимитах.

## Решение (Solution Architecture)
1. Backoff + джиттер
   - В `src/llm.py`: для 429 — экспоненциальный backoff (base=0.5s, factor=2, max=30s) + джиттер 0–20%.
2. Circuit breaker
   - На N ошибок за окно T — «open» на M секунд, все запросы идут на fallback.
3. Fallback
   - Автопереключение на NVIDIA/OpenAI-совместимый провайдер при открытом breaker или после k неудачных попыток одного провайдера.
4. Телееметрия/логи
   - Счётчики 429, время в open-состоянии, успешность фолбэка.
5. Тесты
   - Юнит: эмуляция 429; проверка таймингов backoff и количества попыток.
   - Интеграция: переключение на альтернативного провайдера и успешное завершение.

## Критерии приемки
- При 429 выполняются повторные попытки с backoff и джиттером.
- Breaker открывается при всплеске 429 и трафик уходит на fallback.
- Логи и метрики фиксируют 429, переключения и результаты.

## Возможные сложности
- Точная настройка порогов breaker (чувствительность/ложные срабатывания).
- Разная семантика 429 у провайдеров, необходимость нормализации ошибок.
- Корректное восстановление из open → half-open → closed.

## Integration Points
- LGDA-011 Observability — метрики 429, состояние breaker, доля fallback.
- LGDA-007 Unified Retry — координация повтора на уровне провайдера vs функции.

## ADR References
- ADR-004 Provider Strategy — маршрутизация провайдеров и фолбэк.
- ADR-005 Observability Strategy — метрики/трейсинг провайдеров.

## Производительность
- Backoff снижает давление и улучшает P99; накладные расходы — задержка по дизайну.
- Кэширование provider health для уменьшения частоты проверок.

## Зависимости
- LGDA-011 (метрики/логи), LGDA-007 (ретраи)

## Оценка трудозатрат
1–1.5 дня | Изменения: 2–3 файла | Тесты: 4–6
