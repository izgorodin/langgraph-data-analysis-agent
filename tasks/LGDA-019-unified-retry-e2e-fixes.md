# LGDA-019: Unified Retry E2E Fixes (LGDA-007 follow-up)

**Priority**: HIGH | **Type**: Reliability | **Parallel**: Can run with LGDA-015

## Архитектурный контекст
Ранее найдены 4 падения в интеграционных тестах единой ретрай-схемы: неочищенное состояние, TypeError list_iterator, recursion limit, нарушение передачи контекста.

## Цель задачи
Устранить дефекты в e2e-реализации ретраев: корректное управление состоянием, предотвращение рекурсии, фиксация контекста.

## Детальный анализ
- `final_state.error` ожидался None, но '' — ошибка в нормализации/сбросе.
- TypeError: list_iterator not subscriptable — некорректная работа с итераторами/коллекциями в ретрае.
- GraphRecursionError при лимите 25 — цикл без выхода.
- Пропажа контекста между попытками — state merge/overwrite баг.

## Решение (Solution Architecture)
1. State hygiene
   - Явное обнуление error-полей перед новой попыткой, корректная нормализация типов.
2. Анти-рекурсия
   - Жёсткий лимит попыток, sentinel-флаги, проверка повторяющихся одинаковых входов.
3. Контекст
   - Гарантированная передача retry_history, причина ретрая, prev_sql.
4. Тесты
   - Восстановить и починить 4 e2e теста, добавить регрессионные.

## Критерии приемки
- Все ранее падавшие e2e тесты зелёные.
- Логи показывают понятные переходы между попытками без рекурсии.

## Возможные сложности
- Граница между уровнями ретраев (функция, провайдер, граф) и их координация.
- Побочные эффекты очистки состояния между попытками.

## Integration Points
- LGDA-007 Unified Retry — основная логика стратегий.
- LGDA-015 SQL Type Errors — кейсы валидации и упрощения запросов.
- LGDA-014 No-Fabrication — финальное поведение при исчерпании попыток.

## ADR References
- ADR-003 Error Handling Strategy — координация ретраев и категоризация ошибок.

## Безопасность
- Ретраи не должны ослаблять SQL-политики и лимиты (MAX_BYTES_BILLED, whitelist таблиц, auto-LIMIT).

## Производительность
- Лимиты попыток и backoff, отсутствие бесконечных циклов.

## Зависимости
- LGDA-007 (основа), LGDA-015

## Оценка трудозатрат
1–1.5 дня | Изменения: 2–4 файла | Тесты: 4–6
