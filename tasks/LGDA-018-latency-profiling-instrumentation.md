# LGDA-018: Latency Profiling per Pipeline Node

**Priority**: HIGH | **Type**: Performance/Observability | **Parallel**: Can run with LGDA-011

## Архитектурный контекст
Замечена «дикая» латентность; непонятно где тратится время. Нужна поузловая инструментализация и сводка.

## Цель задачи
Добавить измерение времени для каждого узла пайплайна (plan, synthesize_sql, validate_sql, execute_sql, analyze_df, report) и агрегировать итоги в конце выполнения.

## Детальный анализ
- Сейчас нет детальной телеметрии по времени узлов.
- Без этого невозможно локализовать узкие места и оптимизировать.

## Решение (Solution Architecture)
1. Таймеры узлов
   - Декоратор/контекст-менеджер для измерения wall-clock времени узла.
2. Агрегация
   - Итоговая сводка в state/логах: per-node duration, total, LLM токены, BQ время.
3. Интеграция с LGDA-011
   - Метрики: Histogram per node, tracing spans.
4. Тесты
   - Юнит: корректность записи длительностей.
   - Интеграция: сводка появляется в финальном результате/логах.

## Критерии приемки
- Для каждого узла фиксируется duration, сводка выводится в логах/метриках.
- Нагрузка на выполнение < 2%.

## Возможные сложности
- Измерение async-кода и корректная агрегация по потокам.
- Влияние трассировки на «горячие» пути выполнения.

## Integration Points
- LGDA-011 Observability — гистограммы на узел, spans для трассировки.
- LGDA-012 Performance — использование профилинга для оптимизаций.

## ADR References
- ADR-005 Observability Strategy — требования к метрикам/трейсингу.

## Безопасность
- Исключить запись чувствительных значений в спаны/логи.

## Производительность
- Сэмплирование/батчинг метрик, отключаемый детальный профайлинг.

## Зависимости
- LGDA-011 (metrics/tracing)

## Оценка трудозатрат
0.5–1 день | Изменения: 2–3 файла | Тесты: 2–3
